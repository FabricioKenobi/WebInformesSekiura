{% extends 'base.html' %}

{% block title %}Editar Borrador{% endblock %}

{% block content %}
<h2>Editar y Enviar Borrador</h2>

<form method="post" enctype="multipart/form-data">
  {% csrf_token %}

  <div class="mb-3">
    <label for="asunto" class="form-label">Asunto:</label>
    <input type="text" class="form-control" id="asunto" name="asunto" value="{{ borrador.asunto }}">
  </div>



  <div class="mb-3">
    <label for="cuerpo_html" class="form-label">Cuerpo del email:</label>
    <textarea id="editor" name="cuerpo_html">{{ borrador.cuerpo }}</textarea>
  </div>

  <div class="mb-3">
    <label for="archivo_adjunto" class="form-label">Archivo adjunto:</label>
    <input type="file" class="form-control" id="archivo_adjunto" name="archivo_adjunto">
    {% if borrador.archivo_adjunto %}
      <p>Archivo actual: <a href="{{ borrador.archivo_adjunto.url }}" target="_blank">{{ borrador.archivo_adjunto.name }}</a></p>
    {% endif %}
    <div id="nombre_archivo_generado" class="mt-2"></div>
  </div>
  <input type="hidden" id="nombre_archivo_guardado" name="nombre_archivo_guardado" value="{{ borrador.nombreArch }}">
  <input type="hidden" name="cliente" value="{{ borrador.cliente.id }}">
  <input type="hidden" name="plantilla" value="{{ borrador.plantilla.id }}">
  <input type="hidden" name="comando_generado" id="comando_generado" value="{{ borrador.comando_generado }}">
  <input type="hidden" name="url_informe" id="url_informe" value="{{ borrador.url_informe }}">
  <input type="hidden" name="enviar_email" value="true">

  <div class="mb-3">
    <a id="dashboard" href="{{ borrador.url_informe }}" target="_blank" rel="noopener noreferrer" class="btn btn-outline-secondary">Editar Informe</a>
    <button id="regen" type="button" class="btn btn-outline-primary" onclick="generarInformeConComandoGuardado()">Generar nuevo informe</button>
  </div>

  <button type="button" class="btn btn-warning" onclick="guardarCambiosBorrador()">Guardar cambios</button>
  <button type="submit" class="btn btn-success" hidden>Enviar Email</button>
  <a href="{% url 'lista_borradores' %}" class="btn btn-secondary">Cancelar</a>
</form>

<script src="https://cdn.ckeditor.com/ckeditor5/41.0.0/classic/ckeditor.js"></script>
<script>
let editorInstance = null;

window.addEventListener('DOMContentLoaded', function() {
  ClassicEditor.create(document.querySelector('#editor'))
    .then(editor => { window.editor = editor; editorInstance = editor; })
    .catch(console.error);

  // Sin fechas: sólo aseguramos el href inicial del botón "Editar Informe"
  regenerarComandoYUrl();
});


function regenerarComandoYUrl() {
  const urlInforme = document.getElementById('url_informe').value;
  document.getElementById('dashboard').href = urlInforme;
}

function generarInformeConComandoGuardado() {
  // Ya no regeneramos nada por fechas; usamos el comando tal cual está en el hidden
  const comandoGuardado = document.getElementById('comando_generado').value;
  const urlInforme = document.getElementById('url_informe').value;
  const statusDiv = document.getElementById('nombre_archivo_generado');
  const nombreArchInput = document.getElementById('nombre_archivo_guardado');
  let nombreArch = nombreArchInput.value || "informe_generado";

  if (!comandoGuardado || !urlInforme) {
    statusDiv.innerHTML = '<div class="alert alert-warning">Datos incompletos para regenerar el informe</div>';
    return;
  }

  statusDiv.innerHTML = '<div class="alert alert-info">Generando informe, por favor espere...</div>';

  fetch('/ejecutar-comando/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': '{{ csrf_token }}'
    },
    body: JSON.stringify({
      comando: comandoGuardado,
      informe: urlInforme,
      nombreArch: nombreArch.replace(/ /g, "_"),
      regenerar: true
    })
  })
  .then(r => r.json())
  .then(data => {
    if (data.ok && data.filename) {
      statusDiv.innerHTML = `
        <div class="alert alert-success">
          Informe regenerado correctamente:
          <a href="/descargar-pdf/${encodeURIComponent(data.filename)}/" target="_blank">Descargar</a>
        </div>
      `;
      document.getElementById('dashboard').href = urlInforme;

      // Si el backend devuelve también el comando realmente usado, sincronizalo:
      if (data.command_used) {
        document.getElementById('comando_generado').value = data.command_used;
      }

      // Actualizar el hidden con el nombre real del archivo generado
      nombreArchInput.value = data.filename;
    } else {
      statusDiv.innerHTML = `
        <div class="alert alert-danger">
          Error al regenerar informe: ${data.error || 'Error desconocido'}
        </div>
      `;
    }
  })
  .catch(error => {
    statusDiv.innerHTML = `<div class="alert alert-danger">Error de conexión: ${error.message}</div>`;
    console.error(error);
  });
}

function guardarCambiosBorrador() {
  // Sin fechas: sólo nos aseguramos de mandar el comando y el archivo generado
  const nombreArchivo = document.getElementById('nombre_archivo_guardado').value;
  if (!nombreArchivo) {
    alert('Por favor, genere el informe antes de guardar');
    return;
  }
  const form = document.querySelector('form');
  const formData = new FormData(form);
  formData.append('guardar', 'true');

  // Forzamos incluir el comando actual en el POST
  formData.set('comando_generado', document.getElementById('comando_generado').value);

  fetch(`/guardar-borrador/{{ borrador.id }}/`, {
    method: 'POST',
    headers: { 'X-CSRFToken': '{{ csrf_token }}' },
    body: formData
  })
  .then(r => r.json())
  .then(data => {
    if (data.ok) {
      window.location.href = "{% url 'home' %}";
    } else {
      alert("Error al guardar borrador: " + (data.error || "Error desconocido"));
    }
  })
  .catch(e => {
    alert("No se pudo conectar al servidor.");
    console.error(e);
  });
}
</script>
{% endblock %}