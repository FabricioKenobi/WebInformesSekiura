<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editar Borrador</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div class="container mt-4">
    <h2>Editar y Enviar Borrador</h2>

    <form id="draftForm" method="post" enctype="multipart/form-data">
        <!-- CSRF Token would go here in Django -->
        
        <div class="mb-3">
            <label for="asunto" class="form-label">Asunto:</label>
            <input type="text" class="form-control" id="asunto" name="asunto" value="Test Subject">
        </div>

        <div class="row mb-3">
            <div class="col-md-6">
                <label for="fecha_1" class="form-label">Fecha Inicio:</label>
                <input type="date" class="form-control" id="fecha_1" name="fecha_1" value="2024-01-01">
            </div>
            <div class="col-md-6">
                <label for="fecha_2" class="form-label">Fecha Fin:</label>
                <input type="date" class="form-control" id="fecha_2" name="fecha_2" value="2024-01-31">
            </div>
        </div>

        <div class="mb-3">
            <label for="cuerpo_html" class="form-label">Cuerpo del email:</label>
            <textarea id="editor" name="cuerpo_html">Test email content</textarea>
        </div>

        <div class="mb-3">
            <label for="archivo_adjunto" class="form-label">Archivo adjunto:</label>
            <input type="file" class="form-control" id="archivo_adjunto" name="archivo_adjunto">
            <p id="current-file-info">Archivo actual: <a href="#" target="_blank">test-report.pdf</a></p>
            <div id="file-status" class="mt-2"></div>
        </div>

        <!-- Hidden fields -->
        <input type="hidden" id="generated_filename" name="generated_filename" value="">
        <input type="hidden" name="cliente" value="1">
        <input type="hidden" name="plantilla" value="1">
        <input type="hidden" name="comando_generado" id="comando_generado" value="">
        <input type="hidden" id="url_informe" value="">
        <input type="hidden" name="enviar_email" value="true">

        <div class="mb-3">
            <button id="dashboard-btn" type="button" class="btn btn-outline-secondary">Editar Informe</button>
            <button id="regenerate-btn" type="button" class="btn btn-outline-primary">Generar nuevo informe</button>
        </div>

        <button type="button" class="btn btn-warning" id="save-draft-btn">Guardar cambios</button>
        <button type="submit" class="btn btn-success" style="display: none;">Enviar Email</button>
        <button type="button" class="btn btn-secondary">Cancelar</button>
    </form>
</div>

<script src="https://cdn.ckeditor.com/ckeditor5/41.0.0/classic/ckeditor.js"></script>
<script>
let editorInstance = null;
let currentBorradorId = 1; // This would come from Django template
let clienteNombre = "TestClient"; // This would come from Django template
let tipoPlantilla = "Monthly"; // This would come from Django template

// Configuration object to store all the dynamic data
const draftConfig = {
    borrador: {
        id: 1,
        nombreArch: "TestClient-Informe-Monthly-2024-01-31.pdf",
        url_informe: "https://example.com/dashboard"
    },
    cliente: {
        nombre: clienteNombre
    },
    plantilla: {
        tipo: tipoPlantilla
    }
};

window.addEventListener('DOMContentLoaded', function() {
    initializeEditor();
    setupEventListeners();
    updateCommandAndUrl();
});

function initializeEditor() {
    ClassicEditor
        .create(document.querySelector('#editor'))
        .then(editor => {
            window.editor = editor;
            editorInstance = editor;
        })
        .catch(error => {
            console.error('CKEditor initialization error:', error);
        });
}

function setupEventListeners() {
    document.getElementById('fecha_1').addEventListener('change', updateCommandAndUrl);
    document.getElementById('fecha_2').addEventListener('change', updateCommandAndUrl);
    document.getElementById('regenerate-btn').addEventListener('click', generateNewReport);
    document.getElementById('save-draft-btn').addEventListener('click', saveDraftChanges);
    
    // Handle manual file upload
    document.getElementById('archivo_adjunto').addEventListener('change', function(e) {
        if (e.target.files.length > 0) {
            const file = e.target.files[0];
            updateFileStatus(`Archivo seleccionado: ${file.name}`, 'info');
        }
    });
}

function updateCommandAndUrl() {
    const fechaInicio = document.getElementById("fecha_1").value;
    const fechaFin = document.getElementById("fecha_2").value;

    if (!fechaInicio || !fechaFin) return;

    // Generate command
    const comando = `generar_informe --cliente="${clienteNombre}" --tipo="${tipoPlantilla}" --fecha-inicio="${fechaInicio}" --fecha-fin="${fechaFin}" --output="${clienteNombre}-Informe-${tipoPlantilla}-${fechaFin}"`;
    
    // Update URL (you can customize this logic)
    const urlInforme = draftConfig.borrador.url_informe;

    document.getElementById('comando_generado').value = comando;
    document.getElementById('url_informe').value = urlInforme;
    document.getElementById('dashboard-btn').onclick = () => window.open(urlInforme, '_blank');
}

function generateNewReport() {
    updateCommandAndUrl();
    
    const comando = document.getElementById('comando_generado').value;
    const urlInforme = document.getElementById('url_informe').value;

    if (!comando || !urlInforme) {
        updateFileStatus('Datos incompletos para regenerar el informe', 'warning');
        return;
    }

    updateFileStatus('Generando informe, por favor espere...', 'info');

    // Simulate the fetch request (replace with your actual endpoint)
    const requestData = {
        comando: comando,
        informe: urlInforme,
        nombreArch: draftConfig.borrador.nombreArch.replace(/ /g, "_"),
        regenerar: true
    };

    // Mock response for demonstration
    setTimeout(() => {
        // Simulate successful generation
        const mockResponse = {
            ok: true,
            filename: `${clienteNombre}-Informe-${tipoPlantilla}-${document.getElementById('fecha_2').value}.pdf`
        };

        handleReportGenerationResponse(mockResponse);
    }, 2000);

    /* 
    // Actual fetch implementation:
    fetch('/ejecutar-comando/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify(requestData)
    })
    .then(response => response.json())
    .then(data => handleReportGenerationResponse(data))
    .catch(error => {
        updateFileStatus(`Error de conexi√≥n: ${error.message}`, 'danger');
        console.error('Error:', error);
    });
    */
}

function handleReportGenerationResponse(data) {
    if (data.ok && data.filename) {
        updateFileStatus(`
            Informe regenerado correctamente: 
            <a href="/descargar-pdf/${encodeURIComponent(data.filename)}/" target="_blank">Descargar</a>
        `, 'success');
        
        // Store the generated filename for saving
        document.getElementById('generated_filename').value = data.filename;
        
        console.log("Archivo generado:", data.filename);
        
        // Update current file info
        document.getElementById('current-file-info').innerHTML = 
            `Archivo actual: <a href="/descargar-pdf/${encodeURIComponent(data.filename)}/" target="_blank">${data.filename}</a>`;
            
    } else {
        updateFileStatus(`Error al regenerar informe: ${data.error || 'Error desconocido'}`, 'danger');
    }
}

function saveDraftChanges() {
    const generatedFilename = document.getElementById('generated_filename').value;
    const manualFile = document.getElementById('archivo_adjunto').files[0];
    
    // Check if we have either a generated file or manual upload
    if (!generatedFilename && !manualFile) {
        alert('Por favor, genere un informe o seleccione un archivo antes de guardar');
        return;
    }

    const formData = new FormData();
    
    // Add all form fields
    formData.append('asunto', document.getElementById('asunto').value);
    formData.append('cuerpo_html', editorInstance ? editorInstance.getData() : document.getElementById('editor').value);
    formData.append('fecha_1', document.getElementById('fecha_1').value);
    formData.append('fecha_2', document.getElementById('fecha_2').value);
    formData.append('comando_generado', document.getElementById('comando_generado').value);
    formData.append('url_informe', document.getElementById('url_informe').value);
    formData.append('cliente', document.querySelector('input[name="cliente"]').value);
    formData.append('plantilla', document.querySelector('input[name="plantilla"]').value);
    formData.append('guardar', 'true');

    // Add file information
    if (manualFile) {
        formData.append('archivo_adjunto', manualFile);
        formData.append('file_source', 'manual');
    } else if (generatedFilename) {
        formData.append('generated_filename', generatedFilename);
        formData.append('file_source', 'generated');
    }

    // Show saving status
    updateFileStatus('Guardando cambios...', 'info');

    // Mock save operation
    setTimeout(() => {
        updateFileStatus('Cambios guardados correctamente', 'success');
        // In real implementation, redirect would happen here
        // window.location.href = "/home/";
    }, 1000);

    /*
    // Actual implementation:
    fetch(`/guardar-borrador/${currentBorradorId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCsrfToken()
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.ok) {
            updateFileStatus('Cambios guardados correctamente', 'success');
            setTimeout(() => {
                window.location.href = "/home/";
            }, 1000);
        } else {
            updateFileStatus(`Error al guardar borrador: ${data.error || "Error desconocido"}`, 'danger');
        }
    })
    .catch(error => {
        updateFileStatus('No se pudo conectar al servidor', 'danger');
        console.error('Save error:', error);
    });
    */
}

function updateFileStatus(message, type) {
    const statusDiv = document.getElementById('file-status');
    const alertClass = `alert alert-${type}`;
    statusDiv.innerHTML = `<div class="${alertClass}">${message}</div>`;
}

function getCsrfToken() {
    // In Django, you would get this from the template or a meta tag
    return 'dummy-csrf-token';
}
</script>
</body>
</html>