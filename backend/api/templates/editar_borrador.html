{% extends 'base.html' %}

{% block title %}Editar Borrador{% endblock %}

{% block content %}
<h2>Editar Borrador</h2>

<form method="post" enctype="multipart/form-data">
  {% csrf_token %}

  <div class="mb-3">
    <label for="asunto" class="form-label">Asunto:</label>
    <input type="text" class="form-control" id="asunto" name="asunto" value="{{ borrador.asunto }}">
  </div>



  <div class="mb-3">
    <label for="cuerpo_html" class="form-label">Cuerpo del email:</label>
    <textarea id="editor" name="cuerpo_html">{{ borrador.cuerpo }}</textarea>
  </div>

  <div class="mb-3">
    <label for="archivo_adjunto" class="form-label">Archivo adjunto:</label>
    <input type="file" class="form-control" id="archivo_adjunto" name="archivo_adjunto">
    {% if borrador.archivo_adjunto %}
      <p>Archivo actual: <a href="{{ borrador.archivo_adjunto.url }}" target="_blank">{{ borrador.archivo_adjunto.name }}</a></p>
    {% endif %}
    <div id="nombre_archivo_generado" class="mt-2"></div>
  </div>
  <input type="hidden" id="nombre_archivo_guardado" name="nombre_archivo_guardado" value="{{ borrador.nombreArch }}">
  <input type="hidden" name="cliente" value="{{ borrador.cliente.id }}">
  <input type="hidden" name="plantilla" value="{{ borrador.plantilla.id }}">
  <input type="hidden" name="url_informe" id="url_informe" value="{{ borrador.url_informe }}">
  <input type="hidden" name="enviar_email" value="true">
  
  <div class="mb-3">
    <a id="dashboard" href="{{ borrador.url_informe }}" target="_blank" rel="noopener noreferrer" class="btn btn-outline-secondary">Editar Informe</a>
    <button id="regen" type="button" class="btn btn-outline-primary" onclick="generarInformeConComandoGuardado()">Generar nuevo informe</button>
  </div>

  <button type="button" class="btn btn-warning" onclick="guardarCambiosBorrador()">Guardar cambios</button>
  <button type="submit" class="btn btn-success" hidden>Enviar Email</button>
  <a href="{% url 'lista_borradores' %}" class="btn btn-secondary">Cancelar</a>
</form>

<script src="https://cdn.ckeditor.com/ckeditor5/41.0.0/classic/ckeditor.js"></script>
<script>


window.addEventListener('DOMContentLoaded', function() {
  ClassicEditor.create(document.querySelector('#editor'))
    .then(editor => { window.editor = editor; editorInstance = editor; })
    .catch(console.error);

  // Sin fechas: sólo aseguramos el href inicial del botón "Editar Informe"
  regenerarComandoYUrl();
});
let editorInstance = null;
// redundante pero seguro:
const form = document.querySelector('form');
const fdTest = new FormData(form);
if (!fdTest.get('nombre_archivo_guardado')) {
  // Si por algún motivo el DOM no reflejó el cambio (raro), lo forzamos
  const hidden = document.querySelector('input[name="nombre_archivo_guardado"]');
  if (hidden) hidden.value = data.filename;
}
function regenerarComandoYUrl() {
  const urlInforme = document.getElementById('url_informe').value;
  document.getElementById('dashboard').href = urlInforme;
}

function generarInformeConComandoGuardado() {
  // Ya no regeneramos nada por fechas; usamos el comando tal cual está en el hidden
  const urlInforme = document.getElementById('url_informe').value;
  const statusDiv = document.getElementById('nombre_archivo_generado');
  const nombreArchInput = document.getElementById('nombre_archivo_guardado');
  let url_informe = document.getElementById('url_informe').value;
  let nombreArch = document.getElementById('nombre_archivo_guardado').value;

  if (!urlInforme) {
    statusDiv.innerHTML = '<div class="alert alert-warning">Datos incompletos para regenerar el informe</div>';
    return;
  }

  statusDiv.innerHTML = '<div class="alert alert-info">Generando informe, por favor espere...</div>';

  fetch('/ejecutar-comando/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': '{{ csrf_token }}'
    },
    body: JSON.stringify({ informe: urlInforme, nombreArch: nombreArch })

  })
  .then(r => r.json())
  .then(data => {
    if (data.ok && data.filename) {
      statusDiv.innerHTML = `
        <div class="alert alert-success">
          Informe regenerado correctamente:
          <a href="/descargar-pdf/${encodeURIComponent(data.filename)}/" target="_blank">Descargar</a>
        </div>
        
      `;
      
      window.open(
      `/descargar-pdf/${encodeURIComponent(data.filename)}/`,
      '_blank'
      );
      document.getElementById('dashboard').href = urlInforme;
      // Actualizar el hidden con el nombre real del archivo generado
      nombreArchInput.value = data.filename;
    } else {
      statusDiv.innerHTML = `
        <div class="alert alert-danger">
          Error al regenerar informe: ${data.error || 'Error desconocido'}
        </div>
      `;
    }
  })
  .catch(error => {
    statusDiv.innerHTML = `<div class="alert alert-danger">Error de conexión: ${error.message}</div>`;
    console.error(error);
  });
}

function guardarCambiosBorrador() {
  const nombreArchivo = document.getElementById('nombre_archivo_guardado').value.trim();
  if (!nombreArchivo) {
    alert('Por favor, genere el informe antes de guardar');
    return;
  }

  const form = document.querySelector('form');
  const formData = new FormData(form);

  // Fuerza que estos campos viajen
  formData.set('nombre_archivo_guardado', nombreArchivo);

  // (Opcional) si usás nombre lógico final:
  const nombreArchInput = document.getElementById('nombreArch');
  if (nombreArchInput) {
    formData.set('nombreArch', nombreArchInput.value.trim());
  }

  // DEBUG: ver qué se envía realmente
  for (const [k, v] of formData.entries()) {
    console.log('FD', k, v);
  }

  fetch(`/guardar-borrador/{{ borrador.id }}/`, {
    method: 'POST',
    headers: { 'X-CSRFToken': '{{ csrf_token }}' }, // NO pongas Content-Type; FormData lo maneja
    body: formData
  })
  .then(r => r.json())
  .then(data => {
    if (data.ok) {
      window.location.href = "{% url 'home' %}";
    } else {
      alert("Error al guardar borrador: " + (data.error || "Error desconocido"));
    }
  })
  .catch(e => {
    alert("No se pudo conectar al servidor.");
    console.error(e);
  });
}

</script>
{% endblock %}