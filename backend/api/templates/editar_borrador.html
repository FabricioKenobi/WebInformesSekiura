{% extends 'base.html' %}

{% block title %}Editar Borrador{% endblock %}

{% block content %}
<h2>Editar y Enviar Borrador</h2>

<form method="post" enctype="multipart/form-data">
  {% csrf_token %}
  
  <div class="mb-3">
    <label for="asunto" class="form-label">Asunto:</label>
    <input type="text" class="form-control" id="asunto" name="asunto" value="{{ borrador.asunto }}">
  </div>

  <div class="row mb-3">
    <div class="col-md-6">
      <label for="fecha_1" class="form-label">Fecha Inicio:</label>
      <input type="date" class="form-control" id="fecha_1" name="fecha_1" value="{{ borrador.fecha_1|date:'Y-m-d' }}" onchange="actualizarFechas()">
    </div>
    <div class="col-md-6">
      <label for="fecha_2" class="form-label">Fecha Fin:</label>
      <input type="date" class="form-control" id="fecha_2" name="fecha_2" value="{{ borrador.fecha_2|date:'Y-m-d' }}" onchange="actualizarFechas()">
    </div>
  </div>

  <div class="mb-3">
    <label for="cuerpo_html" class="form-label">Cuerpo del email:</label>
    <textarea id="editor" name="cuerpo_html">{{ borrador.cuerpo }}</textarea>
  </div>

  <div class="mb-3">
    <label for="archivo_adjunto" class="form-label">Archivo adjunto:</label>
    <input type="file" class="form-control" id="archivo_adjunto" name="archivo_adjunto">
    {% if borrador.archivo_adjunto %}
      <p>Archivo actual: <a href="{{ borrador.archivo_adjunto.url }}" target="_blank">{{ borrador.archivo_adjunto.name }}</a></p>
    {% endif %}
    <div id="nombre_archivo_generado" class="mt-2"></div>
  </div>

  <input type="hidden" name="cliente" value="{{ borrador.cliente.id }}">
  <input type="hidden" name="plantilla" value="{{ borrador.plantilla.id }}">
  <input type="hidden" name="comando_generado" id="comando_generado" value="{{ borrador.comando_generado }}">
  <input type="hidden" name="enviar_email" value="true">

  <div class="mb-3">
    <a id="dashboard" href="" target="_blank" rel="noopener noreferrer" class="btn btn-outline-secondary">Editar Informe</a>
    <button id="regen" type="button" class="btn btn-outline-primary" onclick="generarInformeConComandoGuardado()">Generar nuevo informe</button>
  </div>

  <button type="submit" class="btn btn-success">Enviar Email</button>
  <a href="{% url 'lista_borradores' %}" class="btn btn-secondary">Cancelar</a>
</form>

<script src="https://cdn.ckeditor.com/ckeditor5/41.0.0/classic/ckeditor.js"></script>
<script>
  function generarInformeConComandoGuardado() {
    const comandoGuardado = document.getElementById('comando_generado').value;
    const statusDiv = document.getElementById('nombre_archivo_generado');
    
    if (!comandoGuardado) {
      statusDiv.innerHTML = '<div class="alert alert-warning">No hay comando guardado para regenerar el informe</div>';
      return;
    }

    statusDiv.innerHTML = '<div class="alert alert-info">Generando informe, por favor espere...</div>';
    
    fetch('/ejecutar-comando/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token }}'
      },
      body: JSON.stringify({
        comando: comandoGuardado,
        regenerar: true
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.ok && data.filename) {
        statusDiv.innerHTML = `
          <div class="alert alert-success">
            Informe regenerado correctamente: 
            <a href="/descargar-pdf/${encodeURIComponent(data.filename)}/" target="_blank">Descargar</a>
          </div>
        `;
      } else {
        statusDiv.innerHTML = `
          <div class="alert alert-danger">
            Error al regenerar informe: ${data.error || 'Error desconocido'}
          </div>
        `;
      }
    })
    .catch(error => {
      statusDiv.innerHTML = `
        <div class="alert alert-danger">
          Error de conexi√≥n: ${error.message}
        </div>
      `;
      console.error('Error:', error);
    });
  }

  ClassicEditor
    .create(document.querySelector('#editor'))
    .catch(error => {
      console.error(error);
    });
</script>
{% endblock %}