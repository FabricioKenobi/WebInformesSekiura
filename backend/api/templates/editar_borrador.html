{% extends 'base.html' %}

{% block content %}
<h2>Editar y Enviar Borrador</h2>

<form method="post" enctype="multipart/form-data">
  {% csrf_token %}
  
  <!-- Campos existentes... -->
  
  <input type="hidden" name="comando_generado" id="comando_generado" value="{{ borrador.comando_generado }}">

  <div class="mb-3">
    <button id="regen" type="button" class="btn btn-outline-primary" 
            onclick="generarInformeConComandoGuardado()">
      Generar informe
    </button>
    <div id="status-informe" class="mt-2"></div>
  </div>

  <!-- Resto del formulario... -->
</form>

<script>
  function generarInformeConComandoGuardado() {
    const comandoGuardado = document.getElementById('comando_generado').value;
    const statusDiv = document.getElementById('status-informe');
    
    if (!comandoGuardado) {
      statusDiv.innerHTML = '<div class="alert alert-warning">No hay comando guardado para regenerar el informe</div>';
      return;
    }

    statusDiv.innerHTML = '<div class="alert alert-info">Generando informe, por favor espere...</div>';
    
    // Extraer nombre de archivo del comando guardado (asumiendo formato --output="nombre")
    const nombreArchivoMatch = comandoGuardado.match(/--output="([^"]+)"/);
    const nombreArchivo = nombreArchivoMatch ? nombreArchivoMatch[1] : 'informe-generado.pdf';

    fetch('/ejecutar-comando/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token }}'
      },
      body: JSON.stringify({
        comando: comandoGuardado,
        nombreArch: nombreArchivo,
        regenerar: true
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.ok && data.filename) {
        statusDiv.innerHTML = `
          <div class="alert alert-success">
            Informe regenerado correctamente: 
            <a href="/descargar-pdf/${encodeURIComponent(data.filename)}/" target="_blank">Descargar</a>
          </div>
        `;
      } else {
        statusDiv.innerHTML = `
          <div class="alert alert-danger">
            Error al regenerar informe: ${data.error || 'Error desconocido'}
          </div>
        `;
      }
    })
    .catch(error => {
      statusDiv.innerHTML = `
        <div class="alert alert-danger">
          Error de conexi√≥n: ${error.message}
        </div>
      `;
      console.error('Error:', error);
    });
  }
</script>