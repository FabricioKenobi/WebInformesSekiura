{% extends 'base.html' %}

{% block title %}Editar Borrador{% endblock %}

{% block content %}
<h2>Editar y Enviar Borrador</h2>

<form method="post" enctype="multipart/form-data">
  {% csrf_token %}

  <div class="mb-3">
    <label for="asunto" class="form-label">Asunto:</label>
    <input type="text" class="form-control" id="asunto" name="asunto" value="{{ borrador.asunto }}">
  </div>

  <div class="row mb-3">
    <div class="col-md-6">
      <label for="fecha_1" class="form-label">Fecha Inicio:</label>
      <input type="date" class="form-control" id="fecha_1" name="fecha_1" value="{{ borrador.fecha_1|date:'Y-m-d' }}">
    </div>
    <div class="col-md-6">
      <label for="fecha_2" class="form-label">Fecha Fin:</label>
      <input type="date" class="form-control" id="fecha_2" name="fecha_2" value="{{ borrador.fecha_2|date:'Y-m-d' }}">
    </div>
  </div>

  <div class="mb-3">
    <label for="cuerpo_html" class="form-label">Cuerpo del email:</label>
    <textarea id="editor" name="cuerpo_html">{{ borrador.cuerpo }}</textarea>
  </div>

  <div class="mb-3">
    <label for="archivo_adjunto" class="form-label">Archivo adjunto:</label>
    <input type="file" class="form-control" id="archivo_adjunto" name="archivo_adjunto">
    {% if borrador.archivo_adjunto %}
      <p>Archivo actual: <a href="{{ borrador.archivo_adjunto.url }}" target="_blank">{{ borrador.archivo_adjunto.name }}</a></p>
    {% endif %}
    <div id="nombre_archivo_generado" class="mt-2"></div>
  </div>
  <input type="hidden" id="nombre_archivo_guardado" name="nombre_archivo_guardado" value="{{ borrador.nombreArch }}">
  <input type="hidden" name="cliente" value="{{ borrador.cliente.id }}">
  <input type="hidden" name="plantilla" value="{{ borrador.plantilla.id }}">
  <input type="hidden" name="comando_generado" id="comando_generado" value="{{ borrador.comando_generado }}">
  <input type="hidden" id="url_informe" value="{{ borrador.url_informe }}">
  <input type="hidden" name="enviar_email" value="true">

  <div class="mb-3">
    <a id="dashboard" href="{{ borrador.url_informe }}" target="_blank" rel="noopener noreferrer" class="btn btn-outline-secondary">Editar Informe</a>
    <button id="regen" type="button" class="btn btn-outline-primary" onclick="generarInformeConComandoGuardado()">Generar nuevo informe</button>
  </div>

  <button type="button" class="btn btn-warning" onclick="guardarCambiosBorrador()">Guardar cambios</button>
  <button type="submit" class="btn btn-success" hidden>Enviar Email</button>
  <a href="{% url 'lista_borradores' %}" class="btn btn-secondary">Cancelar</a>
</form>

<script src="https://cdn.ckeditor.com/ckeditor5/41.0.0/classic/ckeditor.js"></script>
<script>
let editorInstance = null;

window.addEventListener('DOMContentLoaded', function() {
  // CKEditor init
  ClassicEditor
    .create(document.querySelector('#editor'))
    .then(editor => {
      window.editor = editor;
      editorInstance = editor;
    })
    .catch(error => {
      console.error(error);
    });

  // Listeners para actualizar comando/URL en cambios de fecha
  document.getElementById('fecha_1').addEventListener('change', regenerarComandoYUrl);
  document.getElementById('fecha_2').addEventListener('change', regenerarComandoYUrl);

  // Ejecutar una vez al cargar la página para setear los valores iniciales
  regenerarComandoYUrl();
});

function regenerarComandoYUrl() {
    const clienteNombre = "{{ borrador.cliente.nombre|escapejs }}";
    const tipoPlantilla = "{{ borrador.plantilla.tipo|escapejs }}";
    const fechaInicio = document.getElementById("fecha_1").value;
    const fechaFin = document.getElementById("fecha_2").value;

    // Armá el nombre del archivo (solo si lo quisieras autoactualizar)
    // const archivo = clienteNombre + "-Informe-" + tipoPlantilla + "-" + fechaFin;

    // Armá el comando igual que en la creación
    const comando = `generar_informe --cliente="${clienteNombre}" --tipo="${tipoPlantilla}" --fecha-inicio="${fechaInicio}" --fecha-fin="${fechaFin}" --output="${clienteNombre}-Informe-${tipoPlantilla}-${fechaFin}"`;

    // Si tu plantilla tiene un código de dashboard podés usarlo así:
    // const dashboardCode = "{{ borrador.plantilla.codigo_dashboard|default:'' }}";
    // const urlInforme = dashboardCode ? 
    //   `https://192.168.0.94/app/dashboards#/view/${dashboardCode}?_g=(time:(from:'${fechaInicio}T03:00:00.000Z',to:'${fechaFin}T02:59:59.000Z'))&_a=(fullScreenMode:!t)` : 
    //   "{{ borrador.url_informe }}";
    const urlInforme = "{{ borrador.url_informe }}";

    document.getElementById('comando_generado').value = comando;
    document.getElementById('url_informe').value = urlInforme;
    document.getElementById('dashboard').href = urlInforme;
}

function generarInformeConComandoGuardado() {
    regenerarComandoYUrl();
    const comandoGuardado = document.getElementById('comando_generado').value;
    const urlInforme = document.getElementById('url_informe').value;
    const statusDiv = document.getElementById('nombre_archivo_generado');
    const nombreArchInput = document.getElementById('archivo_adjunto');
    let nombreArch = nombreArchInput.value || "informe_generado";

    if (!comandoGuardado || !urlInforme) {
        statusDiv.innerHTML = '<div class="alert alert-warning">Datos incompletos para regenerar el informe</div>';
        return;
    }

    statusDiv.innerHTML = '<div class="alert alert-info">Generando informe, por favor espere...</div>';

    fetch('/ejecutar-comando/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            comando: comandoGuardado,
            informe: urlInforme,
            nombreArch: nombreArch.replace(/ /g, "_"),
            regenerar: true
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.ok && data.filename) {
            statusDiv.innerHTML = `
                <div class="alert alert-success">
                    Informe regenerado correctamente: 
                    <a href="/descargar-pdf/${encodeURIComponent(data.filename)}/" target="_blank">Descargar</a>
                </div>
            `;
            console.log("Archivo generado:", data.filename);
            document.getElementById('dashboard').href = urlInforme;
            
            // Actualiza el input del formulario con el nombre real del archivo generado
            document.getElementById('archivo_adjunto').value = data.filename;
            
            // También actualiza el valor en el formulario para que se envíe correctamente
            const form = document.querySelector('form');
            if (form) {
                const hiddenInput = form.querySelector('input[name="archivo_adjunto"]');
                if (hiddenInput) {
                    hiddenInput.value = data.filename;
                } else {
                    const newInput = document.createElement('input');
                    newInput.type = 'hidden';
                    newInput.name = 'archivo_adjunto';
                    newInput.value = data.filename;
                    form.appendChild(newInput);
                }
            }
        } else {
            statusDiv.innerHTML = `
                <div class="alert alert-danger">
                    Error al regenerar informe: ${data.error || 'Error desconocido'}
                </div>
            `;
        }
    })
    .catch(error => {
        statusDiv.innerHTML = `
            <div class="alert alert-danger">
                Error de conexión: ${error.message}
            </div>
        `;
        console.error('Error:', error);
    });
}

function guardarCambiosBorrador() {
    const nombreArchivo = document.getElementById('nombre_archivo_guardado').value;
    if (!nombreArchivo) {
        alert('Por favor, genere el informe antes de guardar');
        return;
    }

    const form = document.querySelector('form');
    const formData = new FormData(form);
    
    // Asegurar que todos los campos necesarios están incluidos
    formData.set('nombre_archivo_guardado', nombreArchivo);
    formData.set('comando_generado', document.getElementById('comando_generado').value);
    formData.set('url_informe', document.getElementById('url_informe').value);
    formData.set('guardar', 'true');
    
    // Agregar el contenido del editor CKEditor
    if (editorInstance) {
        formData.set('cuerpo_html', editorInstance.getData());
    }

    fetch(`/guardar-borrador/{{ borrador.id }}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: formData
    })
    .then(r => r.json())
    .then(data => {
        if (data.ok) {
            window.location.href = "{% url 'home' %}";
        } else {
            alert("Error al guardar borrador: " + (data.error || "Error desconocido"));
        }
    })
    .catch(e => {
        alert("No se pudo conectar al servidor.");
        console.error(e);
    });
}
</script>
{% endblock %}
