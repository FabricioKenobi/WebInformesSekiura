{% extends 'base.html' %}
{% block title %}Soc Home{% endblock %}

{% block content %}
<!-- CKEditor 5 CDN -->
<script src="https://cdn.ckeditor.com/ckeditor5/41.0.0/classic/ckeditor.js"></script>

<div id="seccion_plantillas">
  <h2>Seleccionar plantilla</h2>
  {% for p in plantillas %}
    <button onclick="seleccionarPlantilla('{{ p.id }}', `{{ p.asunto|escapejs }}`, `{{ p.cuerpo_base|escapejs }}`, `{{p.tipo}}`)">
      {{ p.tipo }}
    </button>
  {% endfor %}
</div>

<div id="seccion_clientes" hidden>
  <h2>Seleccionar cliente</h2>
  {% for c in clientes %}
    <button onclick="seleccionarCliente('{{ c.id }}', '{{ c.nombre }}', '{{ c.email_1 }}','{{ c.lista_emails }}','{{c.IPSIEM}}','{{c.FQDN}}', '{{c.diario}}','{{c.semanal}}','{{c.mensual}}')">
      {{ c.nombre }}
    </button>
  {% endfor %}
</div>

<form method="post" enctype="multipart/form-data">
  <div id="seccion_fecha" hidden>
    <label>Fecha 1:</label>
    <input type="date" name="fecha_1" id="fecha_1" class="form-control mb-2" onchange="actualizarPreview()">
    
    <label>Fecha 2:</label>
    <input type="date" name="fecha_2" id="fecha_2" class="form-control mb-2" onchange="actualizarPreview()">
    <button type="button" onclick="seleccionarFechas()">Continuar</button>
  </div>

  <div id="seccion_previsualizacion" hidden>
    {% csrf_token %}
    <input type="hidden" name="cliente" id="cliente_id">
    <input type="hidden" name="plantilla" id="plantilla_id">

    <div id="seccion_archivo">
      <label>Adjuntar archivo:</label>
      <input type="file" name="archivo_adjunto" class="form-control mb-3" onchange="archivoAgregado()">
    </div>

    <div id="seccion_texto">
      <hr><h2>游늯 Vista previa</h2>
      <div id="preview_emails" class="mt-3 bg-light p-3 border rounded">
        <strong>游닓 Correos:</strong>
        <ul id="lista_emails" class="mb-0">
          <li>Seleccion치 un cliente</li>
        </ul>
        <div class="mt-2"><strong>游늹 Archivo:</strong> <span id="nombre_archivo">Ning칰n archivo seleccionado</span></div>
      </div>

      <label>Asunto:</label>
      <input type="text" name="asunto" id="asunto" class="form-control mb-2">

      <label>Cuerpo:</label>
      <textarea id="editor" name="cuerpo_html">{% autoescape off %}{{ cuerpo_html }}{% endautoescape %}</textarea>
      
      <div class="mt-3">
        <button id="regen" type="button" onclick="regenInforme()" class="btn btn-primary">
          <span id="regen-text">Generar Informe PDF</span>
          <span id="regen-spinner" class="spinner-border spinner-border-sm" hidden></span>
        </button>
        <a id="dashboard" href="#" target="_blank" class="btn btn-secondary ml-2">Ver Dashboard</a>
      </div>
      
      <button type="submit" id="enviar" class="btn btn-success w-100 mt-3" hidden>九괦잺 Enviar email</button>
    </div>
  </div>
</form>

<style>
.spinner-border {
    vertical-align: middle;
    margin-left: 5px;
}
</style>
<style>
.loader {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    padding: 20px;
    background: rgba(0,0,0,0.8);
    color: white;
    border-radius: 5px;
    z-index: 1000;
}
</style>
<script>
let cliente_nombre = "";
let cuerpo_base_original = "";
let tipoPlantilla = "";
let ip = "";
let fqdn = "";
let codeDiario = "";
let codeMes = "";
let codeSemanal = "";
let fechatemp = new Date();
let informe = "";
let nombreArch = "";

// Inicializar CKEditor
ClassicEditor
  .create(document.querySelector('#editor'))
  .then(editor => {
    window.miEditor = editor;
  })
  .catch(error => {
    console.error('Error al iniciar CKEditor:', error);
  });

function seleccionarPlantilla(id, asunto, cuerpo, tipo) {
  document.getElementById("plantilla_id").value = id;
  document.getElementById("asunto").value = asunto;
  cuerpo_base_original = cuerpo;
  tipoPlantilla = tipo.toLowerCase().trim();

  document.getElementById("seccion_plantillas").hidden = true;
  document.getElementById("seccion_clientes").hidden = false;
}

function seleccionarCliente(id, nombre, email, emails, IPSIEM, FQDN, diario, semanal, mensual) {
  document.getElementById("cliente_id").value = id;
  cliente_nombre = nombre;
  ip = IPSIEM;
  fqdn = FQDN;
  codeDiario = diario;
  codeSemanal = semanal;
  codeMes = mensual;
  
  const hoy = new Date();
  const offset = hoy.getTimezoneOffset();
  hoy.setMinutes(hoy.getMinutes() - offset);
  const fechaActual = hoy.toISOString().split('T')[0];
  document.getElementById("fecha_2").value = fechaActual;
  
  let fecha2 = new Date(hoy);
  let diasSumar = 0;
  fechatemp = hoy;

  if (tipoPlantilla.includes('diario')) diasSumar = 1;
  if (tipoPlantilla.includes('semanal')) diasSumar = 7;
  if (tipoPlantilla.includes('mensual')) diasSumar = 30;
    
  fecha2.setDate(fecha2.getDate() - diasSumar);
  const fecha2Formateada = fecha2.toISOString().split('T')[0];
  document.getElementById("fecha_1").value = fecha2Formateada;

  document.getElementById("seccion_clientes").hidden = true;
  document.getElementById("seccion_fecha").hidden = false;

  const lista = document.getElementById("lista_emails");
  lista.innerHTML = emails ? emails : "Sin correos previos.";
}

function seleccionarFechas() {
  event.preventDefault();
  document.getElementById("seccion_fecha").hidden = true;
  document.getElementById("seccion_previsualizacion").hidden = false;
  actualizarPreview();
}

function archivoAgregado() {
  const inputArchivo = document.querySelector('input[name="archivo_adjunto"]');
  const nombreArchivoSpan = document.getElementById('nombre_archivo');

  if (inputArchivo.files && inputArchivo.files[0]) {
    nombreArchivoSpan.textContent = inputArchivo.files[0].name;
  } else {
    nombreArchivoSpan.textContent = "Ning칰n archivo seleccionado";
  }
}

function formatearFecha(fechaStr) {
  if (!fechaStr) return "__/__/____";
  const fecha = new Date(fechaStr);
  let texto = fecha.toLocaleDateString('es-ES', { 
    weekday: 'long', 
    day: 'numeric', 
    month: 'long', 
    year: 'numeric', 
    timeZone: 'UTC' 
  });
  return texto.replace(/\b\w/g, l => l.toUpperCase()).replaceAll('De','de');
}

async function regenInforme() {
    const btnRegen = document.getElementById("regen");
    const originalText = btnRegen?.textContent;
    
    try {
        // Mostrar estado de carga
        if (btnRegen) {
            btnRegen.disabled = true;
            btnRegen.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generando PDF...';
        }

        // Mostrar modal de carga
        const modal = document.createElement('div');
        modal.style.position = 'fixed';
        modal.style.top = '0';
        modal.style.left = '0';
        modal.style.width = '100%';
        modal.style.height = '100%';
        modal.style.backgroundColor = 'rgba(0,0,0,0.7)';
        modal.style.zIndex = '9999';
        modal.style.display = 'flex';
        modal.style.justifyContent = 'center';
        modal.style.alignItems = 'center';
        modal.innerHTML = `
            <div style="background: white; padding: 20px; border-radius: 5px;">
                <h3>Generando informe PDF...</h3>
                <p>Este proceso puede tardar varios minutos</p>
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
                <div id="progress-text" class="mt-2"></div>
            </div>
        `;
        document.body.appendChild(modal);

        // Ejecutar la generaci칩n del PDF
        const response = await fetch('/ejecutar-comando/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ 
                informe: informe,
                nombreArch: nombreArch 
            })
        });

        const data = await response.json();
        
        if (!data.ok) {
            throw new Error(data.error || "Error desconocido al generar PDF");
        }

        // Forzar descarga con par치metro de cache
        const downloadUrl = `${data.download_url}?t=${Date.now()}`;
        const link = document.createElement('a');
        link.href = downloadUrl;
        link.click();
        
    } catch (error) {
        console.error("Error al generar informe:", error);
        
        // Mostrar error detallado
        const errorDiv = document.createElement('div');
        errorDiv.style.position = 'fixed';
        errorDiv.style.top = '20px';
        errorDiv.style.left = '50%';
        errorDiv.style.transform = 'translateX(-50%)';
        errorDiv.style.zIndex = '10000';
        errorDiv.style.padding = '15px';
        errorDiv.style.backgroundColor = '#ff4444';
        errorDiv.style.color = 'white';
        errorDiv.style.borderRadius = '5px';
        errorDiv.innerHTML = `
            <strong>Error al generar el informe:</strong><br>
            ${error.message}<br>
            <small>Consulta la consola para m치s detalles</small>
            <button onclick="this.parentElement.remove()" style="float: right; background: none; border: none; color: white;">칑</button>
        `;
        document.body.appendChild(errorDiv);
        
    } finally {
        // Restaurar estado original
        if (btnRegen) {
            btnRegen.disabled = false;
            btnRegen.textContent = originalText;
        }
        if (modal) {
            document.body.removeChild(modal);
        }
    }
}

// Funciones auxiliares para mostrar mensajes
function mostrarError(mensaje) {
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert alert-danger alert-dismissible fade show';
    alertDiv.style.position = 'fixed';
    alertDiv.style.top = '20px';
    alertDiv.style.right = '20px';
    alertDiv.style.zIndex = '10000';
    alertDiv.innerHTML = `
        <strong>Error!</strong> ${mensaje}
        <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
    `;
    document.body.appendChild(alertDiv);
    setTimeout(() => alertDiv.remove(), 10000);
}

function mostrarExito(mensaje) {
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert alert-success alert-dismissible fade show';
    alertDiv.style.position = 'fixed';
    alertDiv.style.top = '20px';
    alertDiv.style.right = '20px';
    alertDiv.style.zIndex = '10000';
    alertDiv.innerHTML = `
        <strong>칄xito!</strong> ${mensaje}
        <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
    `;
    document.body.appendChild(alertDiv);
    setTimeout(() => alertDiv.remove(), 5000);
}

function mostrarExito(mensaje) {
    const successDiv = document.createElement('div');
    successDiv.className = 'alert alert-success';
    successDiv.style.position = 'fixed';
    successDiv.style.top = '20px';
    successDiv.style.right = '20px';
    successDiv.style.zIndex = '1000';
    successDiv.style.maxWidth = '400px';
    successDiv.innerHTML = `
        <strong>칄xito!</strong> ${mensaje}
        <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
    `;
    document.body.appendChild(successDiv);
    
    setTimeout(() => successDiv.remove(), 5000);
}
function actualizarPreview() {
  let asunto = document.getElementById("asunto").value;
  let fecha_1 = document.getElementById("fecha_1").value;
  let fecha1 = formatearFecha(fecha_1);
  
  let fecha_2 = document.getElementById("fecha_2").value;
  let fechatemp1 = new Date(fecha_2);
  fechatemp1.setDate(fechatemp1.getDate()-1);
  let fecha2 = formatearFecha(fecha_2);

  let link = `<a href="https://${ip}/app/vulnerability-detection">https://${ip}/app/vulnerability-detection</a>`;
  let fqdnlink = `<a href="https://${fqdn}/app/vulnerability-detection">https://${fqdn}/app/vulnerability-detection</a>`;
 
  let ini = `(from:'${fecha_1}T03:00:00.000Z',to:'${fecha_2}T02:59:59.000Z')`;
  let encodedIni = encodeURIComponent(ini);
  
  let informeDiario = `<a href="https://${ip}/app/dashboards#/view/${codeDiario}?_g=(time:${encodedIni})&_a=(fullScreenMode:!t)" target="_blank">Informe Diario</a>`;
  let informeSemanal = `<a href="https://${ip}/app/dashboards#/view/${codeSemanal}?_g=(time:${encodedIni})&_a=(fullScreenMode:!t)" target="_blank">Informe Semanal</a>`;
  let informeMensual = `<a href="https://${ip}/app/dashboards#/view/${codeMes}?_g=(time:${encodedIni})&_a=(fullScreenMode:!t)" target="_blank">Informe Mensual</a>`;
  
  if(tipoPlantilla.includes('proto')){
      if(tipoPlantilla.includes('diario')){
          informe = `https://${ip}/app/dashboards#/view/${codeDiario}?_g=(time:${encodedIni})&_a=(fullScreenMode:!t)`;
          nombreArch = `${cliente_nombre}-Informe-Ejecutivo-Diario-${fecha_2}.pdf`;
      } else if(tipoPlantilla.includes('semanal')){
          informe = `https://${ip}/app/dashboards#/view/${codeSemanal}?_g=(time:${encodedIni})&_a=(fullScreenMode:!t)`;
          nombreArch = `${cliente_nombre}-Informe-Ejecutivo-Semanal-${fecha_2}.pdf`;
      } else if(tipoPlantilla.includes('mensual')){
          informe = `https://${ip}/app/dashboards#/view/${codeMes}?_g=(time:${encodedIni})&_a=(fullScreenMode:!t)`;
          nombreArch = `${cliente_nombre}-Informe-Ejecutivo-Mensual-${fecha_2}.pdf`;
      }
      
      const dashboardLink = document.getElementById('dashboard');
      if (dashboardLink) {
          dashboardLink.href = informe;
      }
  }

  let asunto_personalizado = asunto
    .replaceAll("{cliente}", cliente_nombre)
    .replaceAll("{fecha_1}", fecha1)
    .replaceAll("{fecha_2}", fecha2)
    .replaceAll("{link}", link);

  document.getElementById("asunto").value = asunto_personalizado;

  let cuerpo_personalizado = cuerpo_base_original
    .replaceAll("{cliente}", cliente_nombre)
    .replaceAll("{fecha_1}", fecha1)
    .replaceAll("{fecha_2}", fecha2)
    .replaceAll("{link}", link)
    .replaceAll("{fqdn}", fqdnlink)
    .replaceAll("{informeDiario}", informeDiario)
    .replaceAll("{informeSemanal}", informeSemanal)
    .replaceAll("{informeMensual}", informeMensual);

  // Reemplazar contenido del editor con la plantilla personalizada
  if (window.miEditor) {
    window.miEditor.setData(cuerpo_personalizado);
  }

  // Actualizar el campo oculto
  document.getElementById('editor').value = cuerpo_personalizado;
}

document.querySelector('form').addEventListener('submit', function () {
  if (window.miEditor) {
    document.getElementById('editor').value = window.miEditor.getData();
  }
});
</script>
{% endblock %}