<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Enviar Email Personalizado</title>
  <style>
    textarea, input[type="text"], input[type="date"], select {
      width: 100%;
      padding: 6px;
      margin-bottom: 12px;
    }
    pre {
      background-color: #f5f5f5;
      padding: 10px;
      white-space: pre-wrap;
      border: 1px solid #ddd;
    }
  </style>
  <script>
    function actualizarVista() {
      const clienteSelect = document.getElementById("cliente");
      const plantillaSelect = document.getElementById("plantilla");
      const fecha1 = document.getElementById("fecha_1").value;
      const fecha2 = document.getElementById("fecha_2").value;
      const asuntoInput = document.getElementById("asunto");
      const cuerpoInput = document.getElementById("cuerpo");
      const previewEmails = document.getElementById("preview_emails");
      const previewAsunto = document.getElementById("preview_asunto");
      const previewCuerpo = document.getElementById("preview_cuerpo");

      const clienteOption = clienteSelect.options[clienteSelect.selectedIndex];
      const plantillaOption = plantillaSelect.options[plantillaSelect.selectedIndex];

      const clienteNombre = clienteOption?.getAttribute("data-nombre") || "";
      const clienteEmails = clienteOption?.getAttribute("data-emails") || "";
      const plantillaCuerpo = plantillaOption?.getAttribute("data-cuerpo") || "";
      const plantillaAsunto = plantillaOption?.getAttribute("data-asunto") || "";

      // Mostrar correos
      previewEmails.innerText = clienteEmails;

      // Cargar plantilla si los campos están vacíos
      if (!asuntoInput.value) {
        asuntoInput.value = plantillaAsunto;
      }

      if (!cuerpoInput.value) {
        cuerpoInput.value = plantillaCuerpo;
      }

      // Reemplazar placeholders solo en vista previa
      const asuntoPreview = asuntoInput.value
        .replace(/{cliente}/g, clienteNombre)
        .replace(/{fecha_1}/g, fecha1 || "____")
        .replace(/{fecha_2}/g, fecha2 || "____");

      const cuerpoPreview = cuerpoInput.value
        .replace(/{cliente}/g, clienteNombre)
        .replace(/{fecha_1}/g, fecha1 || "____")
        .replace(/{fecha_2}/g, fecha2 || "____");

      previewAsunto.innerText = asuntoPreview;
      previewCuerpo.innerText = cuerpoPreview;
    }
  </script>
</head>
<body>
  <h1>Enviar Email Personalizado</h1>

  <form method="post">
    {% csrf_token %}

    <!-- Cliente -->
    <label for="cliente">Cliente:</label>
    <select name="cliente" id="cliente" onchange="actualizarVista()" required>
      <option value="">-- Seleccioná un cliente --</option>
      {% for c in clientes %}
        <option value="{{ c.id }}" data-nombre="{{ c.nombre }}" data-emails="{{ c.lista_emails }}">
          {{ c.nombre }}
        </option>
      {% endfor %}
    </select>
    <small id="preview_emails" style="color: gray;">Seleccioná un cliente</small><br><br>

    <!-- Plantilla -->
    <label for="plantilla">Tipo de Email:</label>
    <select name="plantilla" id="plantilla" onchange="actualizarVista()" required>
      <option value="">-- Seleccioná una plantilla --</option>
      {% for p in plantillas %}
        <option value="{{ p.id }}" data-asunto="{{ p.asunto|escape }}" data-cuerpo="{{ p.cuerpo_base|escape }}">
          {{ p.tipo }}
        </option>
      {% endfor %}
    </select><br><br>

    <!-- Fechas -->
    <label for="fecha_1">Fecha principal:</label>
    <input type="date" name="fecha_1" id="fecha_1" onchange="actualizarVista()" required><br>

    <label for="fecha_2">Fecha secundaria:</label>
    <input type="date" name="fecha_2" id="fecha_2" onchange="actualizarVista()"><br><br>

    <!-- Asunto -->
    <label for="asunto">Asunto:</label>
    <input type="text" name="asunto" id="asunto" oninput="actualizarVista()" required><br>

    <!-- Cuerpo -->
    <label for="cuerpo">Cuerpo del email:</label>
    <textarea name="cuerpo" id="cuerpo" rows="6" oninput="actualizarVista()" required></textarea><br>

    <!-- Botón -->
    <input type="submit" value="Enviar Email">
  </form>

  <!-- Vista previa -->
  <h3>Vista previa del asunto:</h3>
  <pre id="preview_asunto">...</pre>

  <h3>Vista previa del cuerpo:</h3>
  <pre id="preview_cuerpo">...</pre>

  <a href="{% url 'home' %}">← Volver</a>
</body>
</html>
